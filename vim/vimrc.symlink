" -----------------------------------------------------------------------------
"  Init stuff
" -----------------------------------------------------------------------------

" Init vim-plug.
call plug#begin('~/.vim/plugged')

" Use the Base16 color scheme.
Plug 'chriskempson/base16-vim'

" Superb comments functionality.
Plug 'tomtom/tcomment_vim'

" Git wrapper.
Plug 'tpope/vim-fugitive'

" Rails features for vim.
Plug 'tpope/vim-rails'

" Mappings to manipulate surroundings: parentheses, brackets, and more.
Plug 'tpope/vim-surround'

" Syntax plugins
Plug 'cakebaker/scss-syntax.vim'
Plug 'jdaihl/vim-less'
Plug 'JulesWang/css.vim'
Plug 'kchmck/vim-coffee-script'
Plug 'mustache/vim-mustache-handlebars'
Plug 'othree/html5.vim'

" Highlight colors in CSS files.
Plug 'ap/vim-css-color'

" Check syntax for errors.
Plug 'scrooloose/syntastic'

" Add browser prefixes to CSS3 properties.
Plug 'vim-scripts/prefixer.vim'

" Looking up documentation.
Plug 'Keithbsmiley/investigate.vim'

" Text filtering and alignment.
Plug 'godlygeek/tabular'

" Enhance netwr (directory explorer).
Plug 'tpope/vim-vinegar'

call plug#end()

" Set color scheme.
set background=dark
colorscheme base16-eighties

" -----------------------------------------------------------------------------
"  1 Important
" -----------------------------------------------------------------------------

" Key sequence to toggle paste mode.
set pastetoggle=<F2>

" -----------------------------------------------------------------------------
"  2 Moving around, searching and patterns
" -----------------------------------------------------------------------------

" Which commands wrap to another line? Backspace and cursors.
set whichwrap+=<,>,h,l,[,]

" Don't jump to the start of line when scrolling.
set nostartofline

" Set path to the folder from which we opened Vim.
set path=$PWD/**

" Do incremental searching.
set incsearch

" Ignore case when searching.
set ignorecase

" -----------------------------------------------------------------------------
"  3 Tags
" -----------------------------------------------------------------------------


" -----------------------------------------------------------------------------
"  4 Displaying text
" -----------------------------------------------------------------------------

" Show some lines around the cursor.
set scrolloff=5

" Wrap lines.
set wrap

" Soft break lines at end of window.
set linebreak

" Preserve indentation.
set breakindent

" Meh.
set fillchars=fold:\
set fillchars+=vert:\|

" Command line height.
set cmdheight=2

" List of strings used for list mode.
set listchars=tab:▸\ ,trail:~

" Display unprintable characters.
" set list

" Turn off lazy redraw.
set nolazyredraw

" Show line numbers.
set number

" Show relative line numbers.
set relativenumber

" -----------------------------------------------------------------------------
"  5 Syntax, highlighting and spelling
" -----------------------------------------------------------------------------

filetype off
filetype indent on
filetype plugin indent on

" Enable syntax themes.
syntax enable

" Don't highlight searches.
set nohlsearch

autocmd Syntax * syn match ExtraWhitespace /\s\+$\| \+\ze\t/ containedin=ALL

" -----------------------------------------------------------------------------
"  6 Multiple windows
" -----------------------------------------------------------------------------

" Always show the statusline.
set laststatus=2

" Change color of statusline according to current mode.
function! InsertStatuslineColor(mode)
  if a:mode == 'i'
    highlight StatusLine ctermfg=4
  elseif a:mode == 'r'
    highlight StatusLine ctermfg=1
  else
    highlight StatusLine ctermbg=18 ctermfg=blue
  endif
endfunction

" Change statusline colors when entering and changing insert mode, and change
" back to default colors when exiting insert mode.
augroup ChangeStatuslineColor
  autocmd!
  autocmd InsertEnter,InsertChange * call InsertStatuslineColor(v:insertmode)
  autocmd InsertLeave * highlight StatusLine ctermbg=10 ctermfg=7
augroup END

" Set the content of the statusline.
set statusline=
set statusline+=%<%f
set statusline+=%(\ %M%)
set statusline+=%(\ %Y%)
set statusline+=%(\ %R%)
set statusline+=%= 
set statusline+=\ %1*%{SyntasticStatuslineFlag()}%*\ 
set statusline+=\ %{fugitive#statusline()}\ 
set statusline+=\ LINE(%l\/%L)

" -----------------------------------------------------------------------------
"  7 Mulitple tab pages
" -----------------------------------------------------------------------------


" -----------------------------------------------------------------------------
"  8 Terminal
" -----------------------------------------------------------------------------

" Terminal connection is fast, baby!
set ttyfast

" -----------------------------------------------------------------------------
"  9 Using the mouse
" -----------------------------------------------------------------------------


" -----------------------------------------------------------------------------
"  10 Printing
" -----------------------------------------------------------------------------


" -----------------------------------------------------------------------------
"  11 Messages and info
" -----------------------------------------------------------------------------

" Shorten messages.
set shortmess=filtIoOA

" Don't display incomplete commands.
set noshowcmd

" Show the cursor position all the time.
set ruler

" Tell us about changes.
set report=0

" Shut the fuck up!
set visualbell

" -----------------------------------------------------------------------------
"  12 Selecting text
" -----------------------------------------------------------------------------


" -----------------------------------------------------------------------------
"  13 Editing text
" -----------------------------------------------------------------------------

" Wrap at 80 chars by default.
" set tw=80

" Allow backspacing over everything in insert mode.
set backspace=2

" Support for numbered/bullet lists.
set formatoptions+=n

" Brackets/braces that is.
set showmatch

" Duration to show matching brace (1/10 sec).
set matchtime=5

" -----------------------------------------------------------------------------
"  14 Tabs and indenting
" -----------------------------------------------------------------------------

" Number of spaces a <Tab> in the text stands for.
set tabstop=2

" Number of spaces used for each step of (auto)indent.
set shiftwidth=2

" Fuck tabs.
set nosmarttab

" If non-zero, number of spaces to insert for a <Tab>.
set softtabstop=2

" Expand tabs to spaces.
set expandtab

" Automatic indent new lines.
set autoindent

" Be smart about it.
set smartindent

" Set color of indent lines.
let g:indentLine_color_term = 0

" -----------------------------------------------------------------------------
"  15 Folding
" -----------------------------------------------------------------------------

" Display all folds open.
set nofoldenable

" Close folds higher than 2.
set foldlevel=2

" Change what's printed on the folded line.
set foldtext=NeatFoldText()

" Fold by syntax.
set foldmethod=syntax

" Disable Ruby comment folds.
let ruby_no_comment_fold=1

" Custom fold function.
function! NeatFoldText() "{{{2
  let line = ' ' . substitute(getline(v:foldstart), '^\s*"\?\s*\|\s*"\?\s*{{' . '{\d*\s*', '', 'g') . ' '
  let lines_count = v:foldend - v:foldstart + 1
  let lines_count_text = '| ' . printf("%10s", lines_count . ' lines') . ' |'
  let foldchar = '·'
  let foldtextstart = strpart('+' . repeat(foldchar, v:foldlevel*2) . line, 0, (winwidth(0)*2)/3)
  let foldtextend = lines_count_text . repeat(foldchar, 8)
  let foldtextlength = strlen(substitute(foldtextstart . foldtextend, '.', 'x', 'g')) + &foldcolumn
  return foldtextstart . repeat(foldchar, winwidth(0)-foldtextlength) . foldtextend
endfunction

" Don't screw up folds when inserting text that might affect them, until
" leaving insert mode. Foldmethod is local to the window.
autocmd InsertEnter * let w:last_fdm=&foldmethod | setlocal foldmethod=manual
autocmd InsertLeave * let &l:foldmethod=w:last_fdm

" -----------------------------------------------------------------------------
"  16 Diff mode
" -----------------------------------------------------------------------------


" -----------------------------------------------------------------------------
"  17 Mapping
" -----------------------------------------------------------------------------

" Allow timing out halfway into a mapping.
set ttimeoutlen=50

" -----------------------------------------------------------------------------
"  18 Reading and writing files
" -----------------------------------------------------------------------------


" -----------------------------------------------------------------------------
"  19 The swap file
" -----------------------------------------------------------------------------

" Don't use a swap file.
set noswapfile

" -----------------------------------------------------------------------------
"  20 Command line editing
" -----------------------------------------------------------------------------

" How does command line completion work?
set wildmode=list:full

" Ignore these file patterns.
set wildignore+=*.exe,*.swp,.DS_Store

" Turn on wild menu.
set wildmenu

" Enable persistent undo, and set location of undo files directory.
set undofile
set undodir=$HOME/.vimundo

" -----------------------------------------------------------------------------
"  21 Executing external commands
" -----------------------------------------------------------------------------


" -----------------------------------------------------------------------------
"  22 Running make and jumping to errors
" -----------------------------------------------------------------------------


" -----------------------------------------------------------------------------
"  23 Language specific
" -----------------------------------------------------------------------------


" -----------------------------------------------------------------------------
"  24 Multi-byte characters
" -----------------------------------------------------------------------------


" -----------------------------------------------------------------------------
"  25 Various
" -----------------------------------------------------------------------------

" Alow virtual edit in visual block.
set virtualedit=block

" Open investigate in Dash
let g:investigate_use_dash=1

" Strip all trailing whitespace in file.
function! StripWhitespace ()
  exec ':%s/ \+$//gc'
endfunction
map ,s :call StripWhitespace ()<CR>

" Toggle linenumber mode.
function! NumberToggle()
  if(&relativenumber == 1)
    set norelativenumber
  else
    set relativenumber
  endif
endfunc


let g:syntastic_ruby_checkers = ['rubocop']
let g:syntastic_ruby_rubocop_args = '-R'
let g:syntastic_always_populate_loc_list = 1
let g:syntastic_enable_signs = 1
let g:syntastic_stl_format = 'SYNTAX(%E{err: %e}%B{ }%W{warn: %w})'

" YOPO (You Only Paste Once) functions. See commit message for more info.
function! s:setup_paste() abort
  let s:paste = &paste
  let s:mouse = &mouse
  set paste
  set mouse=
endfunction

augroup unimpaired_paste
  autocmd!
  autocmd InsertLeave *
        \ if exists('s:paste') |
        \   let &paste = s:paste |
        \   let &mouse = s:mouse |
        \   unlet s:paste |
        \   unlet s:mouse |
        \ endif
augroup END

" -----------------------------------------------------------------------------
"  26 Remapping
" ----------------------------------------------------------------------------

" YOPO mappings.
nnoremap <silent> <Plug>unimpairedPaste :call <SID>setup_paste()<CR>
nnoremap <silent> yo :call <SID>setup_paste()<CR>o
nnoremap <silent> yO :call <SID>setup_paste()<CR>O

" Set leader to <space>
let mapleader = "\<Space>"

" Allow indented comments. See https://news.ycombinator.com/item?id=3124188
" for more info.
inoremap # X<BS>#

" Compile LESS files.
nnoremap <leader>m :w <BAR> !lessc % > %:t:r.css<CR><space>

" Increase and decerase numbers under the cursor.
nnoremap <leader>a <C-a>
nnoremap <leader>x <C-x>

" Exit to normal mode with 'jj'
inoremap jj <ESC>

" Remap tagging because Norwegian keyboards <3.
nnoremap <C-y> <C-]>

" Toggle comments with leader + c.
nmap <leader>c <c-_><c-_>

" Change linenumber mode with leader + l.
nnoremap <leader>l :call NumberToggle()<CR>

" Reflow paragraph with Q in normal and visual mode.
nnoremap Q gqap
xnoremap Q gq

" Sane movement with wrap turned on.
nnoremap j gj
nnoremap k gk
xnoremap j gj
xnoremap k gk

" Quickly edit/reload the vimrc file.
nnoremap <silent> <leader>ev :e $MYVIMRC<CR>
nnoremap <silent> <leader>sv :so $MYVIMRC<CR>

" Use Q for formatting the current paragraph (or selection).
xnoremap Q gq
nnoremap Q gqap

" Disable arrow keys in both normal and insert mode.
nnoremap <up> <nop>
nnoremap <down> <nop>
nnoremap <left> <nop>
nnoremap <right> <nop>
inoremap <up> <nop>
inoremap <down> <nop>
inoremap <left> <nop>
inoremap <right> <nop>

" Easy window navigation.
nnoremap <C-h> <C-w>h
nnoremap <C-j> <C-w>j
nnoremap <C-k> <C-w>k
nnoremap <C-l> <C-w>l

" Quickly change buffers by pressing leader + b and a number.
nnoremap <leader>b :buffer <C-z><S-Tab>
nnoremap <leader>B :vert sbuffer <C-z><S-Tab>

" Copy and paste to system clipboard.
xnoremap <leader>y "+y
xnoremap <leader>d "+d
nnoremap <leader>p "+p
nnoremap <leader>P "+P
xnoremap <leader>p "+p
xnoremap <leader>P "+P

" Save a file with leader + w.
nnoremap <leader>w :w<CR>

" Save a file as root (sudo).
cmap w!! w !sudo tee % >/dev/null

noremap <leader>i :set ts=4 sw=4 noet <BAR> retab! <BAR> set ts=2 sw=2 et <BAR> retab<CR>
noremap <leader>o :set ts=2 sw=2 noet <BAR> retab! <BAR> set ts=4 sw=4 et <BAR> retab<CR>

" Better tab navigation.
nnoremap th :tabfirst<CR>
nnoremap tj :tabprev<CR>
nnoremap tk :tabnext<CR>
nnoremap tl :tablast<CR>
nnoremap tn :tabnew<CR>
nnoremap tq :tabclose<CR>

" Map keys to find files.
nnoremap <leader>f :find *
nnoremap <leader>s :sfind *
nnoremap <leader>v :vert sfind *

" Open the local-directory browser of current file.
nnoremap <leader>k :Explore<CR>

if exists(':Tabularize')
  nnoremap <leader>a= :Tabularize /=<CR>
  xnoremap <leader>a= :Tabularize /=<CR>
  nnoremap <leader>a: :Tabularize /:\zs<CR>
  xnoremap <leader>a: :Tabularize /:\zs<CR>
endif

" Look up documentation with leader + K.
nnoremap <leader>K :call investigate#Investigate()<CR>

" Display highlight group of word below cursor.
nnoremap <F9> :echo map(synstack(line('.'), col('.')), 'synIDattr(v:val, "name")')<CR>


" -----------------------------------------------------------------------------
"  27 Color highlighting
" -----------------------------------------------------------------------------

highlight CursorLineNr ctermbg=0 ctermfg=9
highlight ExtraWhitespace ctermbg=red ctermfg=white
highlight FoldColumn term=bold ctermbg=10 ctermfg=7
highlight Folded term=bold ctermbg=0 ctermfg=7
highlight LineNr ctermbg=0
highlight StatusLine ctermbg=10 ctermfg=7
highlight StatusLineNC ctermbg=10 ctermfg=11
highlight User1 ctermbg=10 ctermfg=1
highlight VertSplit ctermbg=black ctermfg=darkgrey
highlight clear SignColumn
